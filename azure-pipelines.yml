trigger:
  - main

pool:
  name: Default

variables:
- group: test-dlt-vars

stages:
- stage: Deploy
  displayName: 'Deploy DLT to Test'
  jobs:
  - job: DeployDLT
    steps:
    - checkout: self
      clean: true

    # 1. Update JSON (your script logic)
    - task: PowerShell@2
      displayName: 'üîß Update JSON'
      inputs:
        targetType: 'inline'
        script: |
          $jsonPath = "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json"
          $catalog = "$(DLT_CATALOG)"  # test_rsmas_catalog
          $schema = "$(DLT_SCHEMA)"
          $secretScope = "$(DLT_SECRET_SCOPE)"
          
          $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
          
          # Update EXACTLY like your Python script
          $json.catalog = $catalog
          $json.schema = $schema
          $json.configuration."rsmas.catalog" = $catalog
          $json.configuration."rsmas.schema" = $schema
          $json.configuration."rsmas.secret.scope" = $secretScope
          
          $json | ConvertTo-Json -Depth 10 | Set-Content $jsonPath -Encoding UTF8
          Write-Host "‚úÖ Updated to $catalog.$schema"

    # 2. FIXED API URL - CORRECT ENDPOINT
    - task: PowerShell@2
      displayName: 'üöÄ Create Pipeline'
      inputs:
        targetType: 'inline'
        script: |
          $host = "$(DATABRICKS_HOST)"
          $token = "$(DATABRICKS_TOKEN)"
          $jsonPath = "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json"
          
          # ‚úÖ CORRECT: /api/2.1/pipelines/ (NO workspace/)
          $apiUrl = "$host/api/2.1/pipelines"
          
          $headers = @{
            'Authorization' = "Bearer $token"
            'Content-Type' = 'application/json'
          }
          
          # Delete existing
          try {
            $pipelines = Invoke-RestMethod -Uri $apiUrl -Headers $headers
            $pipelineName = (Get-Content $jsonPath | ConvertFrom-Json).name
            $existing = $pipelines | Where-Object { $_.name -eq $pipelineName }
            if ($existing) {
              Invoke-RestMethod -Uri "$apiUrl/$($existing.id)" -Method Delete -Headers $headers
              Write-Host "üóëÔ∏è Deleted existing"
              Start-Sleep 2
            }
          } catch { Write-Host "‚ÑπÔ∏è No existing pipeline" }
          
          # Create pipeline
          $body = Get-Content $jsonPath -Raw
          $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers -Body $body
          
          Write-Host "‚úÖ Pipeline ID: $($response.id)"
          Write-Host "##vso[task.setvariable variable=PipelineId]$($response.id)"

    # 3. Upload files to WORKSPACE API
    - task: PowerShell@2
      displayName: 'üìÅ Upload Files'
      inputs:
        targetType: 'inline'
        script: |
          $host = "$(DATABRICKS_HOST)"
          $token = "$(DATABRICKS_TOKEN)"
          $wsUrl = "$host/workspace/api/2.0/workspace/import"  # ‚úÖ Workspace API
          $headers = @{'Authorization' = "Bearer $token"}
          
          $folders = @('transformations')
          foreach($folder in $folders) {
            $path = "$(Build.SourcesDirectory)/Product Master/$folder/*.py"
            Get-ChildItem $path -ErrorAction SilentlyContinue | ForEach-Object {
              $relPath = "$folder/$($_.Name)"
              $dbPath = "/Repos/RSMAS_ADB/dlt/product_master/$relPath"
              
              $content = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes((Get-Content $_.FullName -Raw)))
              $body = @{content=$content; path=$dbPath; overwrite=$true} | ConvertTo-Json
              
              Invoke-RestMethod -Uri $wsUrl -Method Post -Headers $headers -Body $body -ContentType "application/json"
              Write-Host "‚úÖ $relPath"
            }
          }

    # 4. Success
    - task: PowerShell@2
      displayName: 'üéâ DONE'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "üöÄ Pipeline deployed!"
          Write-Host "$(DATABRICKS_HOST)#pipeline/$(PipelineId)"
