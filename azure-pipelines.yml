trigger:
  - main

pool:
  name: 'RSMAS-Agent'

variables:
- group: test-dlt-vars  # ‚úÖ TEST ENVIRONMENT

stages:
- stage: Deploy
  displayName: 'Deploy DLT to Test'
  jobs:
  - job: DeployDLT
    displayName: 'Deploy Pipeline'
    steps:
    - checkout: self
      clean: true

    # Update JSON for TEST environment
    - task: PowerShell@2
      displayName: 'üîß Update Config for Test'
      inputs:
        targetType: 'inline'
        script: |
          $jsonPath = "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json"
          $catalog = "$(DLT_CATALOG)"
          $schema = "$(DLT_SCHEMA)"
          $secretScope = "$(DLT_SECRET_SCOPE)"
          
          Write-Host "Updating $jsonPath for TEST env"
          
          $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
          $json.catalog = $catalog
          $json.schema = $schema
          $json.configuration."rsmas.catalog" = $catalog
          $json.configuration."rsmas.schema" = $schema
          $json.configuration."rsmas.secret.scope" = $secretScope
          
          $json | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
          Write-Host "‚úÖ JSON updated!"

    # Create DLT Pipeline
    - task: PowerShell@2
      displayName: 'üöÄ Create Pipeline'
      inputs:
        targetType: 'inline'
        script: |
          $host = "$(DATABRICKS_HOST)"
          $token = "$(DATABRICKS_TOKEN)"
          $jsonPath = "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json"
          
          $headers = @{
            'Authorization' = "Bearer $token"
            'Content-Type' = 'application/json'
          }
          
          $body = Get-Content $jsonPath -Raw
          $uri = "$host/api/2.1/pipelines"
          
          $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
          Write-Host "‚úÖ Pipeline ID: $($response.id)"
          
          Write-Host "##vso[task.setvariable variable=PipelineId]$($response.id)"

    # Upload Python files
    - task: PowerShell@2
      displayName: 'üìÅ Upload Python Code'
      inputs:
        targetType: 'inline'
        script: |
          $host = "$(DATABRICKS_HOST)"
          $token = "$(DATABRICKS_TOKEN)"
          $sourceDir = "$(Build.SourcesDirectory)/Product Master/transformations"
          
          $headers = @{'Authorization' = "Bearer $token"}
          
          Get-ChildItem $sourceDir -Filter "*.py" -Recurse | ForEach-Object {
            $file = $_.FullName
            $relPath = $file.Substring("$sourceDir/".Length).Replace('\','/')
            $dbPath = "/Repos/RSMAS_ADB/dlt/product_master/transformations/$relPath"
            
            $content = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes((Get-Content $file -Raw)))
            $body = @{content=$content; path=$dbPath; overwrite=$true} | ConvertTo-Json
            
            Invoke-RestMethod -Uri "$host/api/2.0/workspace/import" -Method Post -Headers $headers -Body $body -ContentType "application/json"
            Write-Host "‚úÖ $relPath"
          }

    # Upload notebooks
    - task: PowerShell@2
      displayName: 'üìì Upload Notebooks'
      inputs:
        targetType: 'inline'
        script: |
          $host = "$(DATABRICKS_HOST)"
          $token = "$(DATABRICKS_TOKEN)"
          
          $headers = @{'Authorization' = "Bearer $token"}
          $dirs = @('explorations', 'utilities')
          
          foreach($dir in $dirs) {
            $path = "$(Build.SourcesDirectory)/Product Master/$dir"
            if(Test-Path $path) {
              Get-ChildItem $path -Filter "*.ipynb" | ForEach-Object {
                $file = $_.FullName
                $relPath = "$dir/$($_.Name)"
                $dbPath = "/Repos/RSMAS_ADB/dlt/product_master/$relPath"
                
                $content = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes((Get-Content $file -Raw)))
                $body = @{content=$content; path=$dbPath; overwrite=$true; format="JUPYTER"} | ConvertTo-Json
                
                Invoke-RestMethod -Uri "$host/api/2.0/workspace/import" -Method Post -Headers $headers -Body $body -ContentType "application/json"
                Write-Host "‚úÖ $relPath"
              }
            }
          }

    - task: PowerShell@2
      displayName: '‚úÖ Verify Deployment'
      inputs:
        targetType: 'inline'
        script: |
          $host = "$(DATABRICKS_HOST)"
          $token = "$(DATABRICKS_TOKEN)"
          $id = "$(PipelineId)"
          
          $headers = @{'Authorization' = "Bearer $token"}
          $uri = "$host/api/2.1/pipelines/$id"
          
          $pipeline = Invoke-RestMethod -Uri $uri -Headers $headers
          Write-Host "üéâ Pipeline '$($pipeline.name)' ready!"
          Write-Host "üîó $host#pipeline/$id"
