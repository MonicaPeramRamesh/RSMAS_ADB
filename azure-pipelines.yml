trigger:
  - main

pool:
  name: Default

variables:
- group: test-dlt-vars

stages:
- stage: Deploy
  displayName: 'Deploy DLT to Test'
  jobs:
  - job: DeployDLT
    steps:
    - checkout: self
      clean: true

    # 1. Update + VALIDATE JSON
    - task: PowerShell@2
      displayName: 'üîß Update & Validate JSON'
      inputs:
        targetType: 'inline'
        script: |
          $jsonPath = "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json"
          $catalog = "$(DLT_CATALOG)"
          $schema = "$(DLT_SCHEMA)"
          $secretScope = "$(DLT_SECRET_SCOPE)"
          
          $json = Get-Content $jsonPath -Raw | ConvertFrom-Json
          
          # Update configs
          $json.catalog = $catalog
          $json.schema = $schema
          if (-not $json.configuration) { $json.configuration = @{} }
          $json.configuration."rsmas.catalog" = $catalog
          $json.configuration."rsmas.schema" = $schema
          $json.configuration."rsmas.secret.scope" = $secretScope
          
          # ‚úÖ CRITICAL: Fix libraries path for TEST
          $json.libraries[0].glob.include = "/Repos/RSMAS_ADB/dlt/product_master/transformations/**"
          $json.root_path = "/Repos/RSMAS_ADB/dlt/product_master"
          
          $json | ConvertTo-Json -Depth 10 | Set-Content $jsonPath -Encoding UTF8
          
          Write-Host "‚úÖ JSON UPDATED:"
          Get-Content $jsonPath | Write-Host

    # 2. TEST API + Create Pipeline
    - task: PowerShell@2
      displayName: 'üöÄ Create Pipeline (Fixed)'
      inputs:
        targetType: 'inline'
        script: |
          $databricksHost = "$(DATABRICKS_HOST)"
          $databricksToken = "$(DATABRICKS_TOKEN)"
          $jsonPath = "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json"
          
          $baseUrl = "$databricksHost/api/2.1"  # ‚úÖ FIXED: No /workspace/ for pipelines API
          
          $headers = @{
            'Authorization' = "Bearer $databricksToken"
            'Content-Type' = 'application/json'
          }
          
          # TEST connection first
          Write-Host "üîç Testing connection to $databricksHost"
          $testUri = "$databricksHost/api/2.0/clusters/list"
          try {
            Invoke-RestMethod -Uri $testUri -Headers $headers -Method Get | Out-Null
            Write-Host "‚úÖ API Connection OK"
          } catch {
            Write-Error "‚ùå Token/URL invalid: $($_.Exception.Message)"
            exit 1
          }
          
          # Delete existing pipeline
          $pipelineName = (Get-Content $jsonPath -Raw | ConvertFrom-Json).name
          try {
            $listUri = "$baseUrl/pipelines"
            $pipelines = Invoke-RestMethod -Uri $listUri -Headers $headers
            $existing = $pipelines | Where-Object { $_.name -eq $pipelineName }
            if ($existing) {
              Write-Host "üóëÔ∏è Deleting: $($existing.id)"
              $deleteUri = "$baseUrl/pipelines/$($existing.id)"
              Invoke-RestMethod -Uri $deleteUri -Method Delete -Headers $headers
              Start-Sleep 3
            }
          } catch {
            Write-Host "‚ÑπÔ∏è Skip delete: $($_.Exception.Message)"
          }
          
          # Create pipeline
          $body = Get-Content $jsonPath -Raw
          $createUri = "$baseUrl/pipelines"
          Write-Host "üì§ Creating pipeline..."
          
          $response = Invoke-RestMethod -Uri $createUri -Method Post -Headers $headers -Body $body
          Write-Host "‚úÖ SUCCESS! Pipeline ID: $($response.id)"
          Write-Host "##vso[task.setvariable variable=PipelineId]$($response.id)"

    # 3. Upload ALL files (Py + IPYNB)
    - task: PowerShell@2
      displayName: 'üìÅ Upload Code'
      inputs:
        targetType: 'inline'
        script: |
          $databricksHost = "$(DATABRICKS_HOST)"
          $databricksToken = "$(DATABRICKS_TOKEN)"
          $baseUrl = "$databricksHost/workspace"  # ‚úÖ Workspace API for files
          $headers = @{'Authorization' = "Bearer $databricksToken"}
          
          $folders = @('transformations', 'explorations', 'utilities')
          foreach($folder in $folders) {
            $sourcePath = "$(Build.SourcesDirectory)/Product Master/$folder"
            if (Test-Path $sourcePath) {
              Get-ChildItem $sourcePath -Include *.py,*.ipynb -Recurse | ForEach-Object {
                $relPath = $_.FullName.Substring($sourcePath.Length + 1).Replace('\','/')
                $dbPath = "/Repos/RSMAS_ADB/dlt/product_master/$folder/$relPath"
                
                $content = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes((Get-Content $_.FullName -Raw)))
                $body = @{content=$content; path=$dbPath; overwrite=$true} | ConvertTo-Json -Depth 3
                
                if ($_.Extension -eq '.ipynb') { 
                  $body = $body -replace '"format":null', '"format":"JUPYTER"' 
                }
                
                Invoke-RestMethod -Uri "$baseUrl/api/2.0/workspace/import" -Method Post -Headers $headers -Body $body -ContentType "application/json" | Out-Null
                Write-Host "‚úÖ $dbPath"
              }
            }
          }

    # 4. Success
    - task: PowerShell@2
      displayName: 'üéâ DEPLOYED'
      inputs:
        targetType: 'inline'
        script: |
          $host = "$(DATABRICKS_HOST)"
          $id = "$(PipelineId)"
          Write-Host "üéâüéâüéâ DLT PIPELINE DEPLOYED üéâüéâüéâ"
          Write-Host "üîó $host#pipeline/$id"
