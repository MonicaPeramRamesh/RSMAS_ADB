trigger:
- main

pool:
  name: Default
  demands:
    - agent.name -equals RSMAS-Agent

variables:
- group: test-dlt-vars  # Databricks credentials & target catalog/schema

# =====================================================
# Stage 1️⃣ Build
# =====================================================
stages:
- stage: Build
  displayName: "Build DLT Artifact"
  jobs:
  - job: BuildJob
    displayName: "Build DLT Artifact"
    pool:
      name: Default
      demands:
        - agent.name -equals RSMAS-Agent
    steps:

    - script: |
        python --version
        pip --version
      displayName: "Verify Python"

    - script: |
        echo "✅ Dependencies installed"
      displayName: "Install dependencies"

    - publish: .
      artifact: DLT_Artifact
      displayName: "Publish DLT Artifact"

# =====================================================
# Stage 2️⃣ Deploy
# =====================================================
- stage: Deploy
  displayName: "Deploy All DLT Pipelines & Notebooks"
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: "Deploy DLT Pipelines & Notebooks"
    pool:
      name: Default
      demands:
        - agent.name -equals RSMAS-Agent
    steps:

    - download: current
      artifact: DLT_Artifact
      displayName: "Download DLT Artifact"

    # 1️⃣ Deploy all DLT pipeline JSONs
    - task: PowerShell@2
      displayName: "Deploy all DLT Pipelines"
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "Deploying DLT pipelines..."
          $jsonFiles = Get-ChildItem -Path ./pipelines -Filter *.json
          foreach ($file in $jsonFiles) {
              Write-Host "Updating pipeline JSON: $($file.FullName)"
              python ./scripts/update_pipeline_json.py --file $file.FullName --catalog $(DLT_CATALOG) --schema $(DLT_SCHEMA) --secret_scope $(DLT_SECRET_SCOPE)

              $pipelineJson = Get-Content $file.FullName -Raw
              $pipelineName = (ConvertFrom-Json $pipelineJson).name

              # Try to create the pipeline
              $response = curl -s -o $null -w "%{http_code}" -X POST `
                  -H "Authorization: Bearer $(DATABRICKS_TOKEN)" `
                  -H "Content-Type: application/json" `
                  -d $pipelineJson `
                  https://$(DATABRICKS_HOST)/api/2.0/pipelines

              if ($response -eq "409") {
                  Write-Host "Pipeline '$pipelineName' exists, updating..."
                  $pipelinesList = curl -s -H "Authorization: Bearer $(DATABRICKS_TOKEN)" https://$(DATABRICKS_HOST)/api/2.0/pipelines | ConvertFrom-Json
                  $pipelineId = ($pipelinesList.pipelines | Where-Object { $_.name -eq $pipelineName }).pipeline_id
                  
                  curl -s -X PATCH `
                      -H "Authorization: Bearer $(DATABRICKS_TOKEN)" `
                      -H "Content-Type: application/json" `
                      -d $pipelineJson `
                      https://$(DATABRICKS_HOST)/api/2.0/pipelines/$pipelineId
              }
          }

    # 2️⃣ Deploy all notebooks
    - task: PowerShell@2
      displayName: "Deploy all Notebooks"
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "Deploying notebooks..."
          $notebooks = Get-ChildItem -Path ./ -Recurse -Filter *.ipynb
          foreach ($nb in $notebooks) {
              $relPath = $nb.FullName.Substring((Get-Location).Path.Length + 1) -replace '\\','/'
              $targetPath = "/Repos/RSMAS_ADB/dlt/$relPath"
              Write-Host "Deploying $($nb.FullName) -> $targetPath"
              
              $content = [Convert]::ToBase64String([System.IO.File]::ReadAllBytes($nb.FullName))
              
              curl -s -X POST `
                -H "Authorization: Bearer $(DATABRICKS_TOKEN)" `
                -H "Content-Type: application/json" `
                -d (@"
{
  "path": "$targetPath",
  "language": "PYTHON",
  "overwrite": true,
  "content": "$content"
}
"@) `
                https://$(DATABRICKS_HOST)/api/2.0/workspace/import
          }
