trigger:
  branches:
    include:
      - main

pool:
  name: Default
  demands:
    - agent.name -equals RSCLP_Agent

resources:
  repositories:
    - repository: TestRepo
      type: git
      name: RSCLP_TEST  # Test repository with test cases
      ref: main

stages:
  # ===========================================
  # STAGE 1: DEPLOY TO DEV
  # ===========================================
  - stage: Deploy_Dev
    displayName: 'Deploy to DEV'
    variables:
      - group: dev-dlt-vars
    jobs:
      - job: DeployDev
        displayName: 'Deploy DLT & Notebooks to DEV'
        steps:
          - template: templates/deploy-dlt.yml
            parameters:
              environment: 'DEV'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)
              dltCatalog: $(DLT_CATALOG)
              dltSchema: $(DLT_SCHEMA)
              dltSecretScope: $(DLT_SECRET_SCOPE)

  # ===========================================
  # STAGE 2: RUN TESTS IN DEV
  # ===========================================
  - stage: Test_Dev
    displayName: 'Run Tests in DEV'
    dependsOn: Deploy_Dev
    variables:
      - group: dev-dlt-vars
    jobs:
      - job: RunTestsDev
        displayName: 'Execute Test Suite in DEV'
        steps:
          - template: templates/run-tests.yml
            parameters:
              environment: 'DEV'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)

  # ===========================================
  # STAGE 3: MANUAL APPROVAL FOR TEST
  # ===========================================
  - stage: Approval_Test
    displayName: 'Approval for TEST'
    dependsOn: Test_Dev
    jobs:
      - job: waitForValidation
        displayName: 'Wait for Manual Approval'
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: 'peram.monica@outlook.com'
              instructions: |
                ✅ DEV deployment completed successfully.
                ✅ All tests passed in DEV.
                
                Please review and approve to deploy to TEST environment.
                
                Verify:
                - DLT pipelines deployed correctly
                - All transformations uploaded
                - Test cases executed successfully
                - Data quality checks passed
              onTimeout: 'reject'

  # ===========================================
  # STAGE 4: DEPLOY TO TEST
  # ===========================================
  - stage: Deploy_Test
    displayName: 'Deploy to TEST'
    dependsOn: Approval_Test
    variables:
      - group: test-dlt-vars
    jobs:
      - job: DeployTest
        displayName: 'Deploy DLT & Notebooks to TEST'
        steps:
          - template: templates/deploy-dlt.yml
            parameters:
              environment: 'TEST'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)
              dltCatalog: $(DLT_CATALOG)
              dltSchema: $(DLT_SCHEMA)
              dltSecretScope: $(DLT_SECRET_SCOPE)

  # ===========================================
  # STAGE 5: RUN TESTS IN TEST
  # ===========================================
  - stage: Test_Test
    displayName: 'Run Tests in TEST'
    dependsOn: Deploy_Test
    variables:
      - group: test-dlt-vars
    jobs:
      - job: RunTestsTest
        displayName: 'Execute Test Suite in TEST'
        steps:
          - template: templates/run-tests.yml
            parameters:
              environment: 'TEST'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)

  # ===========================================
  # STAGE 6: MANUAL APPROVAL FOR PROD
  # ===========================================
  - stage: Approval_Prod
    displayName: 'Approval for PROD'
    dependsOn: Test_Test
    jobs:
      - job: waitForValidation
        displayName: 'Wait for Manual Approval'
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            inputs:
              notifyUsers: 'peram.monica@outlook.com'
              instructions: |
                ✅ TEST deployment completed successfully.
                ✅ All tests passed in TEST.
                
                ⚠️  This is PRODUCTION deployment - proceed with caution!
                
                Please review and approve to deploy to PROD environment.
                
                Verify:
                - TEST deployment successful
                - All test cases passed
                - Data quality validated
                - Ready for production
              onTimeout: 'reject'

  # ===========================================
  # STAGE 7: DEPLOY TO PROD
  # ===========================================
  - stage: Deploy_Prod
    displayName: 'Deploy to PROD'
    dependsOn: Approval_Prod
    variables:
      - group: prod-dlt-vars
    jobs:
      - job: DeployProd
        displayName: 'Deploy DLT & Notebooks to PROD'
        steps:
          - template: templates/deploy-dlt.yml
            parameters:
              environment: 'PROD'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)
              dltCatalog: $(DLT_CATALOG)
              dltSchema: $(DLT_SCHEMA)
              dltSecretScope: $(DLT_SECRET_SCOPE)

  # ===========================================
  # STAGE 8: RUN TESTS IN PROD
  # ===========================================
  - stage: Test_Prod
    displayName: 'Run Tests in PROD'
    dependsOn: Deploy_Prod
    variables:
      - group: prod-dlt-vars
    jobs:
      - job: RunTestsProd
        displayName: 'Execute Test Suite in PROD'
        steps:
          - template: templates/run-tests.yml
            parameters:
              environment: 'PROD'
              databricksHost: $(DATABRICKS_HOST)
              databricksToken: $(DATABRICKS_TOKEN)
