trigger:
  - main

pool:
  name: Default

variables:
- group: test-dlt-vars

stages:
- stage: Deploy
  displayName: 'Deploy DLT to Test'
  jobs:
  - job: DeployDLT
    steps:
    - checkout: self
      clean: true

    # 1. Install Databricks CLI
    - task: PowerShell@2
      displayName: 'ğŸ“¦ Install Databricks CLI'
      inputs:
        targetType: 'inline'
        script: |
          pip install databricks-cli
          Write-Host "âœ… Databricks CLI installed"

    # 2. Configure CLI with token
    - task: PowerShell@2
      displayName: 'ğŸ”‘ Configure CLI'
      inputs:
        targetType: 'inline'
        script: |
          databricks configure --token
          # Echo token to config (CLI reads from stdin)
          "$(DATABRICKS_TOKEN)" | databricks configure --token
          "$(DATABRICKS_HOST)" | databricks configure --token
          Write-Host "âœ… CLI configured"

    # 3. Update JSON with Python script
    - task: PowerShell@2
      displayName: 'ğŸ”§ Update JSON'
      inputs:
        targetType: 'inline'
        script: |
          python "$(Build.SourcesDirectory)/Product Master/scripts/update_pipeline_json.py" `
            --file "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json" `
            --catalog "$(DLT_CATALOG)" `
            --schema "$(DLT_SCHEMA)" `
            --secret_scope "$(DLT_SECRET_SCOPE)"
          Write-Host "âœ… JSON updated"

    # 4. Upload files to workspace
    - task: PowerShell@2
      displayName: 'ğŸ“ Upload Files'
      inputs:
        targetType: 'inline'
        script: |
          $sourceDir = "$(Build.SourcesDirectory)/Product Master"
          databricks workspace import_dir $sourceDir "/Repos/RSMAS_ADB/dlt/product_master" -o '{"overwrite": true}'
          Write-Host "âœ… All files uploaded"

    # 5. Create/Update Pipeline
    - task: PowerShell@2
      displayName: 'ğŸš€ Create Pipeline'
      inputs:
        targetType: 'inline'
        script: |
          $jsonPath = "$(Build.SourcesDirectory)/Product Master/pipelines/product_master.json"
          databricks pipelines create --json-file $jsonPath
          Write-Host "âœ… Pipeline created/updated"

    # 6. Success
    - task: PowerShell@2
      displayName: 'ğŸ‰ SUCCESS'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "ğŸš€ DLT DEPLOYED!"
          Write-Host "$(DATABRICKS_HOST)#pipeline/"
