parameters:
  - name: environment
    type: string
  - name: databricksHost
    type: string
  - name: databricksToken
    type: string

steps:
  - task: PowerShell@2
    displayName: 'Discover and Run Tests in ${{ parameters.environment }}'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "============================================================"
        Write-Host "  Running Tests in ${{ parameters.environment }}"
        Write-Host "============================================================"
        
        $headers = @{
          Authorization = "Bearer ${{ parameters.databricksToken }}"
          "Content-Type" = "application/json"
        }
        
        # ========================================================
        # STEP 1: Discover Test Pipelines
        # ========================================================
        Write-Host "`nüìã Discovering test pipelines from Databricks..."
        
        try {
          $testsPath = [uri]::EscapeDataString("/Workspace/Shared/Tests/pipelines")
          $testResult = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.0/workspace/list?path=$testsPath" `
            -Headers $headers `
            -Method Get
          
          $pipelineFolders = $testResult.objects | Where-Object { $_.object_type -eq "DIRECTORY" }
          
          if ($pipelineFolders.Count -eq 0) {
            Write-Host "‚ö†Ô∏è  No test pipelines found in /Workspace/Shared/Tests/pipelines" -ForegroundColor Yellow
            exit 0
          }
          
          Write-Host "‚úÖ Found $($pipelineFolders.Count) pipeline(s) to test:"
          foreach ($folder in $pipelineFolders) {
            Write-Host "  - $($folder.path.Split('/')[-1])"
          }
          
        } catch {
          Write-Host "‚ùå Failed to discover test pipelines: $($_.Exception.Message)" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "============================================================"
        
        # ========================================================
        # STEP 2: Run Tests for Each Pipeline (Serverless)
        # ========================================================
        $totalTests = 0
        $passedTests = 0
        $failedTests = 0
        $testResults = @()
        
        foreach ($pipelineFolder in $pipelineFolders) {
          $pipelineName = $pipelineFolder.path.Split('/')[-1]
          
          Write-Host "`nüß™ Testing Pipeline: $pipelineName"
          Write-Host "============================================================"
          
          # Check if run_tests.ipynb exists
          $notebookPath = "$($pipelineFolder.path)/utils/run_tests.ipynb"
          
          Write-Host "üìì Looking for test notebook at: $notebookPath"
          
          try {
            $encodedNotebookPath = [uri]::EscapeDataString($notebookPath)
            $notebookCheck = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.0/workspace/get-status?path=$encodedNotebookPath" `
              -Headers $headers `
              -Method Get `
              -ErrorAction Stop
            
            Write-Host "  ‚úÖ Found test notebook"
          } catch {
            Write-Host "  ‚ùå Test notebook not found at: $notebookPath" -ForegroundColor Red
            $failedTests++
            $testResults += [PSCustomObject]@{
              Pipeline = $pipelineName
              Status = "FAILED"
              Reason = "Test notebook not found"
              Duration = "0s"
            }
            continue
          }
          
          # ========================================================
          # Run Notebook Using Serverless (No Cluster Config!)
          # ========================================================
          Write-Host "üöÄ Running tests for $pipelineName (serverless)..."
          
          try {
            # Simple job configuration - serverless by default
            $jobConfig = @{
              run_name = "Test_${pipelineName}_${{ parameters.environment }}_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
              timeout_seconds = 3600  # 1 hour timeout
              tasks = @(
                @{
                  task_key = "run_tests"
                  notebook_task = @{
                    notebook_path = $notebookPath
                    base_parameters = @{
                      environment = "${{ parameters.environment }}"
                      pipeline_name = $pipelineName
                    }
                  }
                }
              )
            } | ConvertTo-Json -Depth 10
            
            # Submit the job
            $jobResponse = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.1/jobs/runs/submit" `
              -Headers $headers `
              -Method Post `
              -Body $jobConfig
            
            $runId = $jobResponse.run_id
            Write-Host "  ‚úÖ Test job submitted (Run ID: $runId)"
            Write-Host "  üìç Job URL: ${{ parameters.databricksHost }}/#job/$runId"
            
            # ========================================================
            # Monitor Job Execution
            # ========================================================
            $maxWaitMinutes = 30
            $pollIntervalSeconds = 10
            $maxPolls = ($maxWaitMinutes * 60) / $pollIntervalSeconds
            $pollCount = 0
            $startTime = Get-Date
            
            $finalState = $null
            $finalResult = $null
            
            while ($pollCount -lt $maxPolls) {
              Start-Sleep -Seconds $pollIntervalSeconds
              $pollCount++
              
              try {
                $runStatus = Invoke-RestMethod "${{ parameters.databricksHost }}/api/2.1/jobs/runs/get?run_id=$runId" `
                  -Headers $headers `
                  -Method Get
                
                $state = $runStatus.state.life_cycle_state
                $result = $runStatus.state.result_state
                
                # Calculate elapsed time
                $elapsed = [math]::Round(((Get-Date) - $startTime).TotalSeconds)
                
                # Show progress
                if ($state -in @("PENDING", "RUNNING", "TERMINATING")) {
                  $stateMessage = ""
                  if ($runStatus.state.state_message) {
                    $stateMessage = " | $($runStatus.state.state_message)"
                  }
                  Write-Host "  ‚è≥ Status: $state | Elapsed: ${elapsed}s$stateMessage"
                } else {
                  # Job finished
                  $finalState = $state
                  $finalResult = $result
                  break
                }
                
              } catch {
                Write-Host "  ‚ö†Ô∏è  Error polling job status: $($_.Exception.Message)" -ForegroundColor Yellow
                Start-Sleep -Seconds 5
              }
            }
            
            # ========================================================
            # Process Results
            # ========================================================
            $duration = [math]::Round(((Get-Date) - $startTime).TotalSeconds)
            
            if ($null -eq $finalState) {
              Write-Host "`n  ‚ùå Test timed out after $maxWaitMinutes minutes" -ForegroundColor Red
              $failedTests++
              $testResults += [PSCustomObject]@{
                Pipeline = $pipelineName
                Status = "TIMEOUT"
                Reason = "Exceeded ${maxWaitMinutes}m timeout"
                Duration = "${duration}s"
                RunId = $runId
              }
            }
            elseif ($finalResult -eq "SUCCESS") {
              Write-Host "`n  ‚úÖ Tests PASSED for $pipelineName (${duration}s)" -ForegroundColor Green
              $passedTests++
              $testResults += [PSCustomObject]@{
                Pipeline = $pipelineName
                Status = "PASSED"
                Reason = "All tests successful"
                Duration = "${duration}s"
                RunId = $runId
              }
            }
            else {
              # Get error details
              $errorMsg = "Unknown error"
              if ($runStatus.state.state_message) {
                $errorMsg = $runStatus.state.state_message
              }
              
              # Try to get task error details
              if ($runStatus.tasks -and $runStatus.tasks[0].state.result_state -eq "FAILED") {
                if ($runStatus.tasks[0].state.state_message) {
                  $errorMsg = $runStatus.tasks[0].state.state_message
                }
              }
              
              Write-Host "`n  ‚ùå Tests FAILED for $pipelineName" -ForegroundColor Red
              Write-Host "     State: $finalState | Result: $finalResult"
              Write-Host "     Error: $errorMsg" -ForegroundColor Red
              
              $failedTests++
              $testResults += [PSCustomObject]@{
                Pipeline = $pipelineName
                Status = "FAILED"
                Reason = "$finalState | $finalResult"
                Error = $errorMsg
                Duration = "${duration}s"
                RunId = $runId
              }
            }
            
            $totalTests++
            
          } catch {
            Write-Host "`n  ‚ùå Failed to run tests: $($_.Exception.Message)" -ForegroundColor Red
            $failedTests++
            $testResults += [PSCustomObject]@{
              Pipeline = $pipelineName
              Status = "ERROR"
              Reason = $_.Exception.Message
              Duration = "0s"
            }
          }
          
          Write-Host "============================================================"
        }
        
        # ========================================================
        # Final Summary
        # ========================================================
        Write-Host "`n"
        Write-Host "============================================================"
        Write-Host "  TEST EXECUTION SUMMARY - ${{ parameters.environment }}"
        Write-Host "============================================================"
        Write-Host "  Total Pipelines Tested: $totalTests"
        Write-Host "  Passed:                 $passedTests" -ForegroundColor Green
        Write-Host "  Failed:                 $failedTests" -ForegroundColor $(if($failedTests -gt 0){'Red'}else{'Green'})
        Write-Host "============================================================"
        
        if ($testResults.Count -gt 0) {
          Write-Host "`nDetailed Results:"
          Write-Host "------------------------------------------------------------"
          foreach ($result in $testResults) {
            $statusColor = if ($result.Status -eq "PASSED") { "Green" } else { "Red" }
            Write-Host "  Pipeline: $($result.Pipeline)" -ForegroundColor Cyan
            Write-Host "    Status:   $($result.Status)" -ForegroundColor $statusColor
            Write-Host "    Duration: $($result.Duration)"
            if ($result.RunId) {
              Write-Host "    Run ID:   $($result.RunId)"
              Write-Host "    Job URL:  ${{ parameters.databricksHost }}/#job/$($result.RunId)"
            }
            if ($result.Status -ne "PASSED") {
              Write-Host "    Reason:   $($result.Reason)" -ForegroundColor Yellow
              if ($result.Error) {
                Write-Host "    Details:  $($result.Error)" -ForegroundColor Yellow
              }
            }
            Write-Host ""
          }
        }
        
        Write-Host "============================================================"
        
        # Exit with error if any tests failed
        if ($failedTests -gt 0) {
          Write-Host "‚ùå $failedTests test(s) failed. Please review the results above." -ForegroundColor Red
          Write-Host "`nüí° Tip: Click the Job URLs above to see detailed error logs in Databricks" -ForegroundColor Cyan
          exit 1
        }
        
        Write-Host "‚úÖ All tests passed successfully in ${{ parameters.environment }}!" -ForegroundColor Green
        Write-Host "============================================================"
